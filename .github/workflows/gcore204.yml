name: Auto Build & Release FastEdge WASM (Rust, Single-File Repo)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add wasm target
        run: rustup target add wasm32-wasip1

      - name: Generate Rust FastEdge project
        run: |
          cargo new myapp --lib
          mkdir -p myapp/.cargo

          # Cargo config
          cat > myapp/.cargo/config.toml << 'EOF'
          [build]
          target = "wasm32-wasip1"
          EOF

          # Cargo.toml
          cat > myapp/Cargo.toml << 'EOF'
          [package]
          name = "myapp"
          version = "0.1.0"
          edition = "2021"

          [lib]
          crate-type = ["cdylib"]

          [dependencies]
          fastedge = "0.2"
          EOF

          # src/lib.rs
          cat > myapp/src/lib.rs << 'EOF'
          use fastedge::{
            body::Body,
            http::{Request, Response, StatusCode, Error},
          };

          #[fastedge::http]
          fn main(_req: Request<Body>) -> Result<Response<Body>, Error> {
            Response::builder()
              .status(StatusCode::NO_CONTENT)
              .body(Body::empty())
          }
          EOF

      - name: Build WASM
        run: |
          cd myapp
          cargo build --release

      - name: Create GitHub Release (fixed tag)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "gcore-fastedge-204"
          name: "Gcore FastEdge 204 WASM"
          files: myapp/target/wasm32-wasip1/release/myapp.wasm
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}